using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace GestureAdapter
{
    /// <summary>
    /// A time-series neural network for detecting gestures.
    /// Replicates the MATLAB Neural Network function generated by the MATLAB NN Tools.
    /// 
    /// TODO: This is a work in progress -- Network weights and structure to be specified 
    /// in a configuration file.
    /// </summary>
    class NeuralNetwork
    {
        private const int InputCount = 8;
        private const int HiddenCount = 20;
        private const int OutputCount = 8;
        private const int DelayCount = 5;
        
        // Input 1 offsets and gains.
        private static readonly double[] X1Step1XOffset = { -161.0625, -78.9375, -12.59, -12.52, -9.69, -9.63, -6.85, -9.26 };
        private static readonly double[] X1Step1Gain = { 0.00784506006374111, 0.0129136400322841, 0.101419878296146, 0.091533180778032, 0.0611060189428659, 0.104547830632514, 0.12012012012012, 0.105097214923805 };
        private static readonly double X1Step1Ymin = -1;
        private static readonly OffsetsAndGains InputOffsetsAndGains = new OffsetsAndGains(X1Step1XOffset, X1Step1Gain, X1Step1Ymin);

        // Output offsets and gains
        private static readonly double[] X2Step1XOffset = { 0, 0, 0, 0, 0, 0, 0, 0 };
        private static readonly double[] X2Step1Gain= { 2, 2, 2, 2, 2, 2, 2, 2 };
        private static readonly double X2Step1Ymin = -1;
        private static readonly OffsetsAndGains OutputOffsetsAndGains = new OffsetsAndGains(X2Step1XOffset, X2Step1Gain, X2Step1Ymin);

        // Input layer weights.
        private static readonly double[] InputBias = { 1.1534329653904651, -4.7504741588672212, -0.2785119448813908, 5.3800809890978059, 6.8432180919725782, -0.70044627452995245, 2.6839085123624402, -2.3610367566173518, 0.28728495672472532, -0.58747240564552894, -1.2971322728736889, 1.3900620784926774, -4.3351909311220531, 0.28459873263124658, -3.9861897124986676, 0.32079598276299343, 4.1938296119177192, 0.47497377598305002, -1.2882604821800654, -6.4615140277110008 };
        private static readonly double[,] InputWeights = new double[HiddenCount, InputCount * DelayCount] { { -0.81889837880982386, 1.9697858316457904, 0.75869758950398891, -0.26904910527297621, -1.0546316386872099, -0.86681087548962832, 1.0028158157127243, -0.62791376774682239, -1.7242460700870552, -2.7343018637653795, 1.6336479701684572, 0.23830681699333156, -1.1494831916414665, 0.73750510554693138, -0.9389862580289311, -1.0166249306891326, 0.56580693646346036, 0.19846341174128512, 0.93552596092412244, 0.014620682399739036, -0.18875792504272432, 1.1526715388840683, 0.87392288565327414, -0.26186229083268198, 0.28902265987089676, 0.20812535363707713, 0.72707296828474843, 0.086156596888352172, -0.22935038186844411, 0.61506495333600286, -0.046942368440940532, 0.22367557742506272, -0.33525096342890831, 1.5163190670627866, 0.2060883208395145, 0.058766645248264665, -0.12486620356360888, -2.1802571287018817, -0.99806873978237931, 0.19036648593313629 }, { 2.1138333499676145, 2.5486361393883405, -0.57565176303509702, -0.86811183571745387, 2.4857353011217835, 1.6299192803887987, -2.2517048890694999, 2.4365763028980254, 0.444467894750606, -0.85545779145444678, -1.2418058081993795, -0.76556140661795435, 0.53125573172356066, -0.93681420422751371, 3.2238079368280852, 0.27096551659528012, 2.8475871920671643, -0.33620604511334623, -0.32650262911258743, 2.8031700000490503, -1.1652489957593428, -1.9914541691842147, 0.4551848685074858, 1.7068883528316627, -4.917492431863197, 0.15415989405745911, -0.25614066514425277, 1.771442271267599, -0.85575560824567021, 0.070052003439691035, -2.7397283827712782, -0.69862385760829071, 4.9191978336107169, 0.99776924013100143, 0.69164603071975539, 0.29021149217771752, 0.19716406135097927, 0.2744752721266589, 4.2672514952841798, -1.350915901638996 }, { 1.2179233803875193, -1.3637605691121704, -0.13838651408705227, -0.36732053467964276, 0.9126877943861158, -1.6082747940339415, -0.28526734414120358, 0.96962170736897879, -1.25876205635663, 4.2160306249549819, -0.77880876269593746, -0.32604859583851453, 1.0768167956080816, 1.9470429259587516, -0.28306750583355439, -0.35348844148514524, 0.27672652354562788, 0.51702412226431838, -0.96081883193054085, 0.3769180240966078, 0.53030127954196971, -1.8456509636720861, 0.31384903540302639, 1.1576079757091735, 0.49029388403720447, 3.63404120979459, -0.70895866996075263, 0.10363935156172284, -0.24018829112002718, -2.5701949421073196, -0.056222388257743672, -1.0903150488660829, 0.3540345715811839, 1.0200500162812542, -0.27401443616909382, 0.19663221052957597, -0.15531811540308654, -1.0383255013183641, 0.65297988717630373, 0.45845630911225121 }, { -4.038759260141715, -1.9442218812597205, -1.4389635516265877, 0.49757894405740827, -1.8547126444371327, -3.7923912005509788, -0.34106455380369155, 1.1870786819609336, 2.1748969676452572, 3.4432127323275412, -2.1999159733424918, 0.81860727392149912, 1.0214901958136071, 3.4913850209834072, -1.7452244649107933, -2.8944564971240423, -1.1168086159860264, 0.4634290282263987, -2.5602991259710697, 0.21777040248871471, 0.32316128640821806, 0.13841854242940066, 0.85288614910063432, -0.11978299593410324, 1.0250726130959158, -0.9210531901961867, 0.94269995195820844, 1.8229526656910602, 0.60092965797669062, 2.2343016583326603, -1.2356342031456484, 0.061625811173653178, -2.474460166156514, -3.3555723945628873, -0.38849626494617545, 0.3458725123964117, -0.30997915698354794, 1.2377930516941529, -0.37250270741518543, -0.23124179090528155 }, { -2.135823489594685, 1.5356994359145193, -0.0092668046176102997, -6.5385385961779452, 3.3928047924454505, 1.6521337768519193, -2.1597197579110619, -4.2023671693326481, 2.7719191211321776, -2.4640359524270776, -0.40513062174081482, -3.7701499280845048, 0.55852969832918986, -4.6205905720627261, 1.3010825575850844, 2.0180039218085994, 1.1317327712269514, 0.23976726945261456, -0.22648597095632628, 0.32905345686163945, -0.30343535987193793, -0.69614767849578452, -0.16666916350753724, -1.2015773397915972, -2.4029913122324449, 0.68194674197105765, -0.4938719266362751, 0.48123394696231275, 1.2591491429915336, 3.4514109313907015, 0.64130160058688734, 3.8280954733364929, 6.8193122992977866, -0.21811495328859998, -1.5167431163697673, 0.3889462339146062, -0.57093042908796232, 0.54132499134960399, -0.59904914311663648, -2.3382459649242335 }, { 0.64781722350200543, 4.9367733094616977, -8.9447789831049942, -5.5423330870891467, 1.5698637253707879, 4.4756017214959485, -0.26915194567964218, 0.28220733628407357, 2.0476685063075992, -1.4475383028193056, -3.618259923906852, -2.1306877983269183, -2.1888360925451646, -4.5133129935433711, -1.0611647244307161, -0.012686159547544207, 0.89119485182027369, 0.46803082067917201, -2.0083386292884247, -3.8096955546510873, -3.4143320154227803, -2.3193124402576255, -1.0755708658667062, -2.479701025438021, 0.8165469798193391, -0.63025083524903192, 1.2298994364214115, -0.56438082299519099, -2.9512747113397353, -6.3855263971720548, 0.69251229597659181, 1.3322343364120521, 3.2669614666709932, 7.1369535168369636, -0.36248554788832094, -0.16422999612126757, 0.20677203178390996, 1.6978044373029302, 2.218959803955443, 1.9055519393654077 }, { 0.094199495738497063, -1.4077695527330198, -0.75768176365123185, 0.31888828632505872, 0.14515428179466816, -2.7865831469899884, 0.27933267705690012, 0.55742295748728399, -1.0416252285062424, 1.0656717087238112, -0.54058406466271436, -0.33965069949534876, 0.32820986383389289, 0.77193882964632898, -1.619472581744263, -0.59475135469918139, 0.063041214854774985, -1.6407670936334624, 1.0973893504708496, 0.11958230068584433, 4.299810096583915, 3.388271797191913, 1.0252954421632281, 0.43430922025966795, -1.9443793626484918, 2.1896350122258053, -0.39577423008193624, -0.085993314369688906, 1.8847444660306854, 2.9444216414286375, -1.8987050901288631, 0.18329624661984439, 1.7545071251971591, -4.1486856691919698, 1.1118924555081162, -0.27394026625289553, 0.40136747719439725, -0.15535019547752896, 1.7648334151337306, -1.5588731450304232 }, { 1.879221432320719, -1.4370658932542952, 1.1155683209743834, 1.8954952231911555, -1.8299495815397626, 1.6430084320822091, -0.77608810152263641, 1.5599120388661327, 1.5024581834892103, -1.5925288772576787, 0.66172014607296847, 0.13336160114885798, -1.2676099161628869, -1.5085186801599608, 3.8868697154781304, -1.4406307870066175, -0.22593883637061085, -1.9179840332674201, 0.87482645107972312, 0.43083206627706799, -0.79442656903602538, 3.7184685074731707, -2.7020203959948947, -0.79059159885141939, -2.9075469954059954, -2.0360998405647655, 0.49201694779490213, 0.042236564001115195, -0.63336696896177558, -1.1532610927044278, 0.85856126202698402, 0.25711498868470695, 1.6286870337687862, -1.1561673884119199, 0.026755755398911799, -0.090855843557570884, -0.34211113630467149, 2.2587602334039651, -0.34856622702708251, -0.20068323863276316 }, { -2.655465586115592, -1.0149577113129553, 3.2529000746208752, -1.3566234169792704, -2.9977999756590874, 3.9120751891372056, -1.4226979884664503, -5.81370651298921, -1.1164868053910075, 1.6302737236448559, 1.6072197917993845, -0.92876603655577605, -0.4256494312207682, -6.4103437884504393, 1.3773735545987644, 3.5132325967177223, 2.6200272625659533, 2.4857585977319276, 0.63563230810787152, -0.33721147870899693, -0.39014274406108007, 0.37440709191000143, -3.274997300805222, -0.30262353999935143, -2.1030541093210662, -1.2536029717282149, 0.40804800666877589, -1.0502815693445877, -0.37754446736718461, 0.069238281802464496, 0.79501673500602688, -0.62291894999822328, 4.3152886532312662, -1.5736858151686124, 0.24252736695152721, 0.42962906179035076, -0.25362143341385135, 2.6497603456229113, 1.0333150272436935, -1.3323649441983465 }, { 0.074901668793808274, -3.8515975113533467, 10.877017135895313, -13.490335676634176, -8.9845762599209866, -3.8444562150300938, 3.0954793452479725, -6.0177038602031141, -0.74666099345840165, 3.8273665595740947, 4.8925471759479624, -1.6984630330397561, 2.8369011615737421, 3.8770549599480102, 2.0669777504988613, 2.6143463658997428, 3.763456105840925, 2.0474280719453302, -4.3404493895755669, -0.44904461839272958, -2.7877286395575918, -3.0207424659533917, -0.19511325776084543, 1.6273241608043347, 3.256390160882944, 0.51138562925992059, 3.0680187525504072, -1.1896827107739207, -0.6377957238310491, -0.02267127067617436, -1.4300904521797539, -2.2504221419913391, -4.6092019880989099, -1.1995823515033086, 0.27649284301957899, 0.16041378803791254, -1.0509165389041337, 1.7687036521709785, -2.5444848791935772, -0.474266204927145 }, { -2.6907369722317247, 4.6377169516756194, 0.24850248950825715, 1.0205987610928835, -1.6265774767284589, -3.2817351625199169, -0.1618442388720242, 0.40674695268823802, 1.2076313480191987, 3.2916493509413352, 0.90629592615950361, 2.7727000214190447, -2.8459516060766843, -5.0998336201721788, 2.1280469734421166, -1.6989021861181288, -1.3455418205938745, 1.7707159367483287, 0.67118692231024157, 2.782920710245516, -1.63868254892343, 1.4940137675668361, -1.2445162184522869, -0.656905571290888, -0.40695761183298862, 1.5726524551046348, 0.49266200101976809, 2.737574553177986, -1.6815224983576433, -2.8727424172580678, 0.20832888391670035, -0.42289437332022339, -0.49045981711344649, 1.3081084471270912, -0.11442062786123278, 0.55130319662140492, -0.70943111592764929, -1.5179286762323436, -0.58692492436179311, -0.60012395423602327 }, { 3.1714820096102123, 1.8514419148103056, -4.8987252508174919, 1.8998100027984601, -0.39242465048579867, 2.1339480044859056, 0.4947121983471624, 1.5340471837692031, -2.0114625598417093, -7.2509679062607182, 0.96095853776759887, -0.2222739924558757, -0.6707391168680501, -3.7966485194539312, 1.3499858624414576, -1.3019446716849787, -0.68602063133353408, 3.0795057724463097, 2.530005568035012, 0.49765915105036024, 1.3154231792667788, 5.86515646370942, -1.98683056442218, 1.8282504207515908, -1.6392018242951483, -3.181040192112647, -1.4423804663135034, -0.032304673694969865, -0.032231763337351893, -1.811208010591046, 0.097130799019319231, -1.6987424503299462, 0.39505501182902047, -0.41407850679368807, -0.13140265548955771, -0.54259508491057429, 0.010117969212789062, 0.70398310763318883, 0.02102128418366498, 0.22327566966889129 }, { 2.3836374689495647, -0.80843021122933922, -0.33406764710918591, -0.59802186334731922, -1.0728194513892866, -2.1579513844827001, -0.0084150027596600341, 1.2434694530374866, 1.6090233696184253, 3.5275420687226537, 0.6431662126629264, -0.97145742137169433, 2.4415039686859235, 8.0638140684493251, 1.3629187565003369, 0.18167094522745697, -1.4113752707822158, -0.86074027374740614, -0.14205443257810499, 0.36193946825079282, -1.495201850703566, -6.1472831504714254, -1.5943713221568772, 1.212710272402524, -1.6085243030157397, -2.3100135901172325, -0.94972397474568282, -0.86548617262584282, -1.8153349781914252, -1.9570083396521551, 0.59692854764019754, -0.45306399633542993, 1.3680754137991491, 4.3746655029752013, -0.65533837860537481, -0.043497066445724791, -1.6026245093392404, -0.31170626265763213, 0.74172819866924589, 0.31899821469986456 }, { 1.798072051514876, 3.152518615713277, -0.14805986893019416, -0.29689998214213958, 2.3642793129304782, -1.2004742593692241, -0.011911806834325855, 0.04081222779027785, -3.5420105470065226, -0.14685866365712824, -0.78307205257180768, -0.3989300033452558, 0.31098290275488472, -0.33260176709536204, -1.0601869725093187, 0.4793451937817742, 1.8808640701511967, 3.4017313156084361, -1.0798903123425088, 0.10734300015982899, 0.42758375916591806, -2.8738406641108343, 1.1596300908612223, 0.98353712085468192, 1.6756053443272503, 5.3086306055658641, -0.6554639910968173, 0.14562750824267479, -0.091073936904243785, -2.7222431407102636, -0.037803755464496075, -1.3177485462018501, -0.800763079207788, 2.3752070616605168, -0.0079383906586930342, 0.15903316614695842, 0.33607155616710349, -2.4757053323430509, 0.26856085892133591, 0.76291791281215604 }, { 2.4208947032528156, -0.92777429653072163, 1.0214933356787197, 1.9395726030168547, -3.1219806519853828, 0.3958188315896376, -1.5083898730973389, 1.6130777499359259, -6.3884308747038414, -0.6585859353314174, -0.43288043536526766, -2.7686471365849687, -2.2314721048983612, 0.16557933082995807, -0.4960411125950176, -1.1707582400553833, 0.89109216287136284, -0.64683393650871623, 0.24187059551583406, -1.0221687174328791, 2.1288790684117633, 0.33915870723302544, -0.20309015827455373, 0.30250743895205978, -3.2082525189792865, -1.3638365998930655, 0.4454767263623341, -0.020790762346798386, 0.14554818157418969, 0.076777684289863535, 0.33112589121853236, 0.31393275888233341, 2.9375587521244046, 2.4787567441420633, 0.80077461670885342, -0.43289427463290153, -1.7298179037139771, -0.066432131528986332, -0.78459753924173636, -1.2385629683869355 }, { 3.013089643803156, 1.0147747923318196, 1.4116686513630805, 0.74992012044976097, 3.3620874317803642, -1.3874904799334855, -6.2749015377479047, 1.1163054237203227, -3.1242327690025942, -2.2329074492616474, 0.18441100038249442, -0.02995797074717034, 2.3206737941261095, 4.4232824666758335, 6.4452352937356192, -0.28785377083775054, 0.11646622357281666, -1.8096962021805001, 0.30003566794205971, 0.64626738018699137, 1.8419604676500902, 2.9277353021481893, -0.0093174871041984131, -0.70953425211615606, -1.0944431914900234, -2.203767121106039, 0.2063876138062235, -0.15832177425432351, 0.39693823236142556, 0.39954107295074659, -1.2676015734076622, 0.74259835238197835, -3.1233428359075086, -0.089837099107014762, 0.43259190067086856, -0.63506865701090265, -0.27036875771196833, -2.6320243327880499, 0.45360948681576968, 0.8910706931854897 }, { 2.6201601163054411, -0.21471507890755148, 1.4900192430104355, 0.40704151551103018, 2.6401296982375624, 4.4490966490737698, 0.13959189423849699, -0.24163839126745135, -2.5345779694432728, -1.7001233277100978, 0.75563604083210101, -0.90410004914743602, 2.1119873491521659, -3.0202769845833144, 0.96841025447724305, -0.45746092005290123, -0.2788952925551067, -1.9148063429494906, 1.1689921990871834, 0.01425451590301444, -0.013834020941545469, -2.5140851618860927, 0.35289348896367334, 1.6089495066696045, 1.1067319151765673, 0.82721866520451437, -0.066239575102631842, -0.47461541827593956, 0.77008472244318649, 2.3021679539096032, -0.67976947501303142, -1.9271958834301228, -1.1047677852821847, -3.0463806096586867, 0.39296807989625093, -1.0964204459410172, 1.4641122852426651, 1.3511877668604695, 0.046253221374983333, 1.513085221277809 }, { -1.2336947561543328, 1.279056704978742, 1.3921931799240355, -0.61714196143077105, -1.2871816122026873, -2.7411954200757531, 0.5247447394664273, -0.80136738697998333, 1.5260497039807546, -0.17381961292663495, 0.53904123477175925, 0.27417019493374134, -0.82551060653746666, -1.2146011856591812, 0.10367129412448478, 0.47723772160486533, -1.1622182424550238, 3.3765107739444682, -0.39304000919955395, 0.082948565590001702, -1.0114488879212811, 0.30230376228272371, -1.1657380305207647, -0.1941179650622131, 1.8784955531201963, -0.3669514044196609, -0.53304666114430066, 0.19451410462304317, 0.1727128272907206, -2.0117331901427637, 2.0299311747896134, -0.1560108524538128, 0.93747973534237605, -4.7887375166455435, -1.3140802711416022, 0.58340168255467084, 0.077476835186398349, 5.8629898336581574, -1.776579591675491, 0.18270940975436895 }, { -0.48224264656912963, 3.5397669498601445, 4.6310303243545423, -0.85357891438957401, 0.60926029154535044, -2.1027307726884588, 0.2534566330895125, -0.66012674369378099, 0.13527675401831246, 2.4266431086784142, 1.8739444428307013, 0.63701191591661299, 1.1540085439242076, 3.0656780417557701, -0.39105086748814211, -0.24521865347949212, 2.746109191375008, -1.349811939176337, -0.26682627659340563, -0.43655361412829202, 1.4133110199713523, -0.8866528885667101, 0.14654342236398318, -0.014490302640585206, 1.7516855542447189, 2.6792661222591718, 1.1269831188945219, -1.0467446180481499, 0.72731097221853869, 1.1376553913089389, 0.84548608956242255, -0.63114324417873369, 1.4134242403475978, -0.35259847907899111, 0.47467585087147468, 1.0069934934282911, -1.1502520713871434, -3.188107539108243, 0.41949094021005184, -1.375077742446335 }, { 1.946138957663017, -17.813767570108364, -1.3020087748016371, -3.437238790036087, -3.8905259356360506, 7.8762420648761191, 1.9080091972396884, 2.5605626948486258, 2.9276319748231492, -5.4454540373375835, -1.1107392031736738, -0.19366901301410261, -0.73754504001774801, 8.415262066391449, 1.338463585432236, -6.2441542271944499, 1.0882557353294877, -4.6133431437427523, -1.6319096907585324, 0.15189185662616528, -0.63710762243591978, 2.5516796339171153, 1.3468167043283816, 6.8891258640866759, -3.1870256093163456, -8.6284132707996619, -0.11058633365542597, -1.5430745003243149, 0.56690798384271579, 3.0398483310743321, 2.0424848960237405, -0.16926243021080056, 0.78459980167851384, -11.003787953379877, -0.35398691460777393, -0.59959910652467119, 0.78128050710895991, 9.3197988702925869, -1.2713457297648794, 0.3956741346919801 } };

        // Hidden layer 1 weights.
        private static readonly double[] LayerBias = { -1.3676669592139183, -0.79639512084471953, -0.42589360388698172, -2.1311603876564464, -0.18412870166510459, -0.048972159128805898, -0.31943719183485964, -0.72634592990045133 };
        private static readonly double[,] LayerWeights = new double[OutputCount, HiddenCount] { { -1.5445672237761781, -0.094456880507274688, 0.18938457013014159, 0.66510496480113113, 0.73244641516925346, -0.72521329498499376, -0.32205363232991879, -0.3644956660701163, -0.75916717536764455, 0.55184079187159818, 0.21441235469328368, 0.95414763352542775, -0.53047176854948952, -0.71440431467148446, 0.01030156384804129, -0.69967397887437222, -0.30162278904364687, -1.0405983287956104, 1.1426148819292707, -0.65895126818857996 }, { -0.045719918773911267, 0.016788887381512539, -2.5389589365397502, -0.16226333200759313, -0.044758930826724511, 0.45938011212879359, 1.1737890915891198, 0.5168882309184436, -0.55455415511626094, -0.063483411258905373, 0.41900761977862389, -0.86778005379712264, 1.1578117295212915, 1.5959896712235482, -0.19849455224368978, -0.026043006792875564, 0.44826305541691386, 1.0185164565830416, 0.29378650087915942, -0.17475810035050365 }, { 0.051402056676226465, -0.7763146412563775, 2.7015306334203055, -1.2994618069349551, 0.12156549695135777, 0.17130115170714794, -0.45606243293129023, 0.13887541703172168, 0.1846385034837337, -0.14332130394119638, 0.34723326209446809, -0.30547018312518548, -0.53360319362443887, -1.4858544900969441, 0.020926974880201704, -0.43875881107304276, 0.6107094908617916, -1.5649650924544158, -0.40607295327968412, 0.11455655876377394 }, { -0.4090502246485439, -0.22163043241888167, 0.78525309408659538, 0.74057240563993143, -0.060584048787597884, 0.21586358811935519, 0.047795858251001286, 0.44087840878745443, 0.84390991656420511, 0.076742051390331259, 0.064995284810798068, 0.27151436233320791, -0.20049572435956872, -0.30665834757102628, -0.71569294218532298, 0.87373190183229454, 0.17820679010186627, 0.35572846960739468, -0.54854097082275177, -0.14901667956377002 }, { -0.13608665837400097, 0.030802371562824168, -0.32903861849466565, 0.0080276967187196992, -0.018710740759786806, -0.066036617073109316, -0.10025443507928464, -0.6605005625947955, 0.076086438203692305, -0.09888782991989141, 0.14122067060749488, -0.22204235907911535, 0.064731705876005241, -0.4094943878498587, 0.97186207319822093, 0.10606506233776047, -0.11768539107213855, 0.24157696351510313, -0.27677838687481748, -0.11792689839123194 }, { 0.031226881380794436, -0.012055650667197174, 0.059895686365897496, 0.037349137096154762, 0.029023292974488669, -0.048876925047866948, 0.0027462523300675369, 0.010127190329977297, 0.062408266726774728, -0.014932642074754469, -0.023686773965640229, 0.020467229155549028, 0.032957790292058184, -0.027048985616616561, -0.037394288159208977, -0.023839646793316113, -0.025710981033805591, -0.061614716192737715, -0.016342498684746985, 0.99529644612998536 }, { 0.34800826782402466, -0.062340165707303594, -1.4562648027854517, 0.19534232725190925, 0.18313795998533361, -0.10849075761530468, -0.016334354515082319, 0.12410805728430088, 0.24157604429036, -0.13282689772806378, -0.03481796160810173, 0.10405443696806579, 0.15135846115476781, 1.7957930583001991, -0.098299351642834945, 0.34127258262492999, -0.95073040896336647, -0.10821036883542151, -0.20683521763440482, -0.02572579115855533 }, { 1.7047872130650967, 1.119207184167067, 0.58819792242959501, -0.18467136021585376, -0.94211956666257046, 0.10207271465282271, -0.32962587930904691, -0.2058809423029847, -0.094897767417517431, -0.1751307129418754, -1.1283643228523343, 0.045108879434936175, -0.14228875760918983, -0.44832161905702594, 0.046789687526031271, -0.13275421415685248, 0.15857020207533373, 1.1595665733968314, 0.018168542476998728, 0.016525779499938699 } };
        
        public NeuralNetwork()
        {
            externalInputs = new double[DelayCount][];
            hidden = new double[HiddenCount];
            outputs = new double[OutputCount];
            outputs[0] = 1.0;
            for (int i = 0; i < DelayCount; i++)
            {
                externalInputs[i] = new double[InputCount];
                double[] inputZeroes = new double[InputCount];
                InputOffsetsAndGains.Apply(inputZeroes, externalInputs[i]);
            }
        }

        // externalInputs[0] are the current inputs, externalInputs[1] 1-step delayed, externalInputs[2] 2-steps delayed.
        private double[][] externalInputs;

        private double[] hidden;
        private double[] outputs;

        public double[] Outputs
        {
            get { return outputs; }
        }

        private int timestep = 0;
        
        private void TimestepInputs()
        {
            // Clear the 2-step delay data,
            Array.Clear(externalInputs[0], 0, InputCount);
            double[] clearedExternal = externalInputs[0];

            // Shuffle 0 and 1-step delay one forward.
            // Place our cleared array at step 0 to be used again.
            externalInputs[0] = externalInputs[1];
            externalInputs[1] = clearedExternal;
        }

        /// <summary>
        /// Runs the Neural Network on the specified input frame.
        /// </summary>
        public void Step(double[] inputs)
        {
            TimestepInputs();
            
            InputOffsetsAndGains.Apply(inputs, externalInputs[1]);

            for (int h = 0; h < HiddenCount; h++)
            {
                double sum = InputBias[h];
                for (int i = 0; i < InputCount * 2; i++) {
                    // [0] is two timesteps ago, [1] is the last timestep.
                    double input = (i >= InputCount) ? externalInputs[0][i - InputCount] : externalInputs[1][i];
                    sum += InputWeights[h, i] * input;
                }
                
                hidden[h] = TransferFunction(sum);
            }

            for (int o = 0; o < OutputCount; o++)
            {
                double sum = LayerBias[o];
                for (int i = 0; i < HiddenCount; i++)
                {
                    sum += LayerWeights[o, i] * hidden[i];
                }
                // No activation function here, apparently.
                outputs[o] = sum;
            }

            OutputOffsetsAndGains.Reverse(outputs, outputs);

        }

        private static double TransferFunction(double n)
        {
            return (2.0 / (1 + Math.Exp(-2 * n))) - 1.0;
        }
    }
}
